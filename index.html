<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Propostas com Autentica칞칚o</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #000);
      color: #333;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      padding: 35px;
    }
    
    header {
      text-align: center;
      padding: 25px 0;
      background: linear-gradient(to right, #1a2a6c, #000);
      color: white;
      border-radius: 10px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
      background-size: cover;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: white;
      position: relative;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    h2 {
      color: #1a2a6c;
      border-bottom: 2px solid #b21f1f;
      padding-bottom: 12px;
      margin: 25px 0 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    h2 i {
      font-size: 1.8rem;
    }
    
    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      padding: 30px;
      margin-bottom: 35px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid #eee;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: linear-gradient(to bottom, #1a2a6c, #b21f1f);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
    }
    
    .form-group {
      margin-bottom: 22px;
      position: relative;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #000;
      font-size: 1.05rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1.05rem;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #1a2a6c;
      outline: none;
      box-shadow: 0 0 0 3px rgba(26, 42, 108, 0.2);
    }
    
    .btn {
      background: linear-gradient(to right, #1a2a6c, #000);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .btn::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }
    
    .btn:hover::after {
      left: 100%;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 15px rgba(0, 0, 0, 0.3);
    }
    
    .btn i {
      margin-right: 10px;
    }
    
    .proposal-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }
    
    .proposal-list th {
      background: linear-gradient(to right, #1a2a6c, #000);
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 600;
    }
    
    .proposal-list td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    } 
    
    .proposal-list tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .proposal-list tr:hover {
      background-color: #f0f5ff;
    }
    
    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.95rem;
      font-weight: 500;
      text-align: center;
      display: inline-block;
      min-width: 180px;
    }
    
    .status-elaboracao {
      background-color: #ffeb3b;
      color: #000;
    }
    
    .status-aprovacao {
      background-color: #f1a10e;
      color: #000;
    }
    
    .status-aprovado {
      background-color: #4caf50;
      color: #000;
    }
    
    .status-cancelado {
      background-color: #f44336;
      color: #000;
    }
    
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.3rem;
      margin: 0 6px;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .edit-btn {
      color: #1a2a6c;
      background: rgba(26, 42, 108, 0.1);
    }
    
    .delete-btn {
      color: #b21f1f;
      background: rgba(178, 31, 31, 0.1);
    }
    
    .action-btn:hover {
      transform: scale(1.15);
      background: white;
    }
    
    .markdown-container {
      background-color: #000;
      color: white;
      border-radius: 10px;
      padding: 30px;
      margin-top: 25px;
      border: 1px solid #dee2e6;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      max-height: 350px;
      overflow-y: auto;
      box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.3);
      display: flex;
    }
    
    .download-btn {
      margin-top: 25px;
      background: linear-gradient(to right, #1a2a6c, #000);
      width: 100%;
    }
    
    footer {
      text-align: center;
      padding: 20px;
      color: #1a2a6c;
      margin-top: 30px;
      font-size: 0.95rem;
      font-weight: 500;
    }
    
    .notification {
      position: fixed;
      top: 25px;
      right: 25px;
      padding: 18px 30px;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      transform: translateX(200%);
      transition: transform 0.4s ease;
      z-index: 1000;
      font-size: 1.1rem;
      max-width: 400px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: linear-gradient(to right, #4caf50, #2e7d32);
    }
    
    .notification.error {
      background: linear-gradient(to right, #f44336, #c62828);
    }
    
    .hidden {
      display: none;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding: 15px 20px;
      background: #f0f5ff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      color: black;
    }
    
    .user-email {
      font-weight: bold;
      color: #1a2a6c;
      font-size: 1.1rem;
    }
    
    .logout-btn {
      background: linear-gradient(to right, #1a2a6c, #000);
      padding: 10px 20px;
    }
    
    .login-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 30px;
    }
    
    .login-card {
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      position: relative;
      overflow: hidden;
    }
    
    .login-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(to right, #1a2a6c, #b21f1f);
    }
    
    .login-title {
      text-align: center;
      margin-bottom: 30px;
      color: #1a2a6c;
    }
    
    .login-title i {
      font-size: 3rem;
      margin-bottom: 15px;
      display: block;
      color: #1a2a6c;
    }
    
    .auth-toggle {
      text-align: center;
      margin-top: 25px;
      color: #666;
    }
    
    .auth-toggle a {
      color: #1a2a6c;
      text-decoration: none;
      font-weight: bold;
      margin-left: 8px;
      cursor: pointer;
    }
    
    .auth-toggle a:hover {
      text-decoration: underline;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .proposal-list {
        font-size: 0.95rem;
      }
      
      .proposal-list th, .proposal-list td {
        padding: 12px;
      }
      
      .user-info {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .login-card {
        padding: 20px;
      }
    }

    .filter-container {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filter-container label {
      margin-bottom: 0;
      white-space: nowrap;
      font-weight: bold;
      color: #1a2a6c;
      font-size: 1.1rem;
    }
    
    .filter-container select {
      flex: 1;
      padding: 12px;
      min-width: 200px;
    }
    
    .filter-btn {
      background: linear-gradient(to right, #1a2a6c, #000);
      padding: 12px 20px;
    }
    
    .client-card {
      background: #f0f5ff;
      padding: 18px;
      border-radius: 10px;
      margin-bottom: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
    }
    
    .client-name {
      font-weight: bold;
      color: #1a2a6c;
      font-size: 1.1rem;
    }
    
    .client-form {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .client-form input {
      flex: 1;
      min-width: 200px;
    }
    
    .client-form button {
      flex-shrink: 0;
    }
    
    /* Modal para links de tabela */
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow: auto;
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 600px;
      position: relative;
      border: 1px solid #1a2a6c;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
    
    .iframe-link {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #f9f9f9;
      cursor: pointer;
      font-family: monospace;
    }
    
    .iframe-container {
      margin-top: 20px;
      padding: 15px;
      background: #f0f5ff;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .iframe-container textarea {
      height: 100px;
      margin-bottom: 10px;
      font-family: monospace;
    }
    
    .iframe-preview {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: center;
    }
    
    .iframe-preview iframe {
      width: 100%;
      height: 300px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    /* Estilos para visualiza칞칚o de cliente */
    .client-view {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
    }
    
    .client-header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(to right, #1a2a6c, #000);
      color: white;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .client-title {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .client-subtitle {
      font-size: 1.2rem;
    }
    
    /* Estilo para o loader */
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #1a2a6c;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #1a2a6c;
    }
    
    .input-wrapper {
      position: relative;
    }
    
    .input-wrapper input {
      padding-left: 45px;
    }
    
    /* Toggle de senha */
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #1a2a6c;
    }
    
    /* Efeito de onda nos bot칫es */
    .ripple {
      position: relative;
      overflow: hidden;
      transform: translate3d(0, 0, 0);
    }
    
    .ripple:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform .5s, opacity 1s;
    }
    
    .ripple:active:after {
      transform: scale(0, 0);
      opacity: .3;
      transition: 0s;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>
  <!-- Visualiza칞칚o de cliente (aparece apenas quando tem clientId na URL) -->
  <div id="client-view" class="client-view hidden">
    <div class="client-header">
      <h1 class="client-title"><i class="fas fa-table"></i> Propostas do Cliente</h1>
      <p class="client-subtitle">Visualiza칞칚o protegida por autentica칞칚o</p>
    </div>
    
    <!-- Formul치rio de autentica칞칚o para cliente -->
    <div id="client-auth-section">
      <div class="login-container">
        <div class="login-card">
          <div class="login-title">
            <h2> <i class="fas fa-lock"></i> Autentica칞칚o Necess치ria </h2>
            <p>Insira o c칩digo de acesso para visualizar as propostas</p>
          </div>

          <div class="login-form">
            <div class="form-group input-wrapper">
              <i class="fas fa-key form-icon"></i>
              <input type="password" id="client-access-code" placeholder="C칩digo de acesso" />
              <i class="fas fa-eye password-toggle" id="toggle-password"></i>
            </div>
            
            <button id="client-login-btn" class="btn ripple">
              <i class="fas fa-unlock"></i> Acessar Propostas
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 츼rea das propostas (aparece ap칩s autentica칞칚o) -->
    <div id="client-proposals-section" class="hidden">
      <table class="proposal-list">
        <thead>
          <tr>
            <th>T칤tulo</th>
            <th>Status</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody id="client-proposals-list"></tbody>
      </table>
      
      <button id="client-logout-btn" class="btn logout-btn" style="margin-top: 20px;">
        <i class="fas fa-sign-out-alt"></i> Sair da Visualiza칞칚o
      </button>
    </div>
  </div>

  <!-- Aplica칞칚o principal (aparece apenas quando n칚o tem clientId) -->
  <div id="app-container" class="container">
    <header>
      <h1><i class="fas fa-file-contract"></i> Gerador de Propostas</h1>
      <p>Gerencie suas propostas com autentica칞칚o segura</p>
    </header>

    <!-- Tela de login -->
    <div id="login-section">
      <div class="login-container">
        <div class="login-card">
          <div class="login-title">
            <i class="fas fa-lock"></i>
            <h2>Acesso ao Sistema</h2>
          </div>

          <div class="login-form">
            <div class="form-group input-wrapper">
              <i class="fas fa-envelope form-icon"></i>
              <input type="email" id="login-email" placeholder="seu@email.com" />
            </div>

            <div class="form-group input-wrapper">
              <i class="fas fa-lock form-icon"></i>
              <input type="password" id="login-password" placeholder="Sua senha" />
              <i class="fas fa-eye password-toggle" id="toggle-admin-password"></i>
            </div>

            <button id="login-btn" class="btn ripple">
              <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Conte칰do do app que s칩 aparece quando usu치rio est치 logado -->
    <div id="app-section" class="hidden">
      <div class="user-info">
        <div>
          <span>Usu치rio: </span>
          <span class="user-email" id="user-email"></span>
        </div>
        <button id="logout-btn" class="btn logout-btn ripple">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
      </div>

      <!-- 츼rea de Propostas -->
      <div class="card">
        <h2><i class="fas fa-plus-circle"></i> Adicionar Nova Proposta</h2>
        
        <!-- Formul치rio de cliente integrado -->
        <div class="client-form">
          <input type="text" id="client-name" placeholder="Nome do cliente" />
          <button id="add-client-btn" class="btn ripple">
           <i class="fas fa-user-plus"></i> Cadastrar Cliente
          </button>
        </div>
        
        <div class="form-group">
          <label for="clients-select">Selecione o Cliente</label>
          <select id="clients-select">
            <option value="">Selecione um cliente</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="proposal-title">T칤tulo da Proposta</label>
          <input type="text" id="proposal-title" placeholder="Digite o t칤tulo da proposta" />
        </div>
        <div class="form-group">
          <label for="proposal-link">Link da Proposta</label>
          <input type="text" id="proposal-link" placeholder="https://exemplo.com/proposta" />
        </div>
        <div class="form-group">
          <label for="proposal-status">Status da Proposta</label>
          <select id="proposal-status">
            <option value="elaboracao">游리 Em elabora칞칚o</option>
            <option value="aprovacao">游 Em aprova칞칚o do cliente</option>
            <option value="aprovado">游릭 Aprovado</option>
            <option value="cancelado">游댮 Cancelado</option>
          </select>
        </div>
        
        <button id="add-proposal" class="btn ripple">
          <i class="fas fa-save"></i> Salvar Proposta
        </button>
      </div>

      <div class="card">
        <h2><i class="fas fa-list"></i> Lista de Propostas</h2>
        
        <!-- Filtro por cliente -->
        <div class="filter-container">
          <label for="proposal-filter">Filtrar por Cliente:</label>
          <select id="proposal-filter">
            <option value="all">Todos os Clientes</option>
          </select>
          <button id="generate-link-btn" class="btn filter-btn ripple">
            <i class="fas fa-link"></i> Gerar Link Seguro
          </button>
        </div>
        
        <table class="proposal-list">
          <thead>
            <tr>
              <th>T칤tulo</th>
              <th>Status</th>
              <th>Cliente</th>
              <th>A칞칫es</th>
            </tr>
          </thead>
          <tbody id="proposals-list"></tbody>
        </table>
      </div>

      <div class="card">
        <h2><i class='fab fa-markdown'></i> Tabela Markdown Gerada</h2>
        <h5>Esta tabela ser치 atualizada automaticamente conforme as propostas s칚o adicionadas ou editadas.</h5>
        <div class="markdown-container" id="markdown-output"></div>
        <button id="download-md" class="btn download-btn ripple">
          <i class="fas fa-download"></i> Baixar Markdown
        </button>
      </div>
    </div>

    <!-- Modal para links de tabela -->
    <div id="link-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2><i class="fas fa-lock"></i> Link Seguro para Cliente</h2>
        <p>Este link requer autentica칞칚o para acessar as propostas:</p>
        
        <div class="form-group">
          <label>C칩digo de Acesso:</label>
          <input type="text" id="access-code" class="iframe-link" readonly onclick="this.select()" />
          <small>Compartilhe este c칩digo com seu cliente para acessar as propostas</small>
        </div>
        
        <div class="form-group">
          <label>Link para Visualiza칞칚o:</label>
          <input type="text" id="iframe-link" class="iframe-link" readonly onclick="this.select()" />
        </div>
        
        <div class="iframe-container">
          <h3><i class="fas fa-code"></i> C칩digo para Incorpora칞칚o (iframe)</h3>
          <p>Copie e cole este c칩digo em qualquer p치gina HTML:</p>
          <textarea id="iframe-code" readonly></textarea>
          <button id="copy-code-btn" class="btn ripple">
            <i class="fas fa-copy"></i> Copiar C칩digo
          </button>
        </div>
      </div>
    </div>

    <div id="notification" class="notification"></div>
  </div>

  <script>
    // Configura칞칚o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhue_2qisBA2Ihe6WPKfonf0NSE4WZnPg",
      authDomain: "gera-propostas.firebaseapp.com",
      projectId: "gera-propostas",
      storageBucket: "gera-propostas.appspot.com",
      messagingSenderId: "517918747792",
      appId: "1:517918747792:web:568b86b22e0e5709823c15",
      measurementId: "G-CJCK09C7D8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Configura칞칚o de persist칡ncia de sess칚o
    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
      .catch((error) => {
        console.error("Erro ao configurar persist칡ncia:", error);
      });

    // Elementos do DOM
    const appContainer = document.getElementById('app-container');
    const clientView = document.getElementById('client-view');
    const loginSection = document.getElementById('login-section');
    const appSection = document.getElementById('app-section');
    const userEmailSpan = document.getElementById('user-email');
    const notification = document.getElementById('notification');
    
    // Elementos de login
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    
    // Elementos Clientes
    const clientNameInput = document.getElementById('client-name');
    const addClientBtn = document.getElementById('add-client-btn');
    const clientsSelect = document.getElementById('clients-select');
    
    // Elementos Propostas
    const proposalTitleInput = document.getElementById('proposal-title');
    const proposalLinkInput = document.getElementById('proposal-link');
    const proposalStatusSelect = document.getElementById('proposal-status');
    const addProposalBtn = document.getElementById('add-proposal');
    const proposalsList = document.getElementById('proposals-list');
    const markdownOutput = document.getElementById('markdown-output');
    
    // Elementos de Filtro
    const proposalFilter = document.getElementById('proposal-filter');
    const generateLinkBtn = document.getElementById('generate-link-btn');
    
    // Modal
    const linkModal = document.getElementById('link-modal');
    const closeModal = document.querySelector('.close');
    const iframeLink = document.getElementById('iframe-link');
    const iframeCode = document.getElementById('iframe-code');
    const copyCodeBtn = document.getElementById('copy-code-btn');
    const accessCodeInput = document.getElementById('access-code');
    
    // Elementos da visualiza칞칚o de cliente
    const clientProposalsList = document.getElementById('client-proposals-list');
    const clientAuthSection = document.getElementById('client-auth-section');
    const clientProposalsSection = document.getElementById('client-proposals-section');
    const clientAccessCodeInput = document.getElementById('client-access-code');
    const clientLoginBtn = document.getElementById('client-login-btn');
    const clientLogoutBtn = document.getElementById('client-logout-btn');
    const togglePassword = document.getElementById('toggle-password');
    const toggleAdminPassword = document.getElementById('toggle-admin-password');
    
    // Vari치veis
    let clients = [];
    let proposals = [];
    let currentFilter = "all";
    let currentProposalId = null;
    let currentClientForLink = null;
    let clientAccessCode = '';
    
    // Fun칞칚o para gerar c칩digos de acesso
    function generateAccessCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }
    
    // Fun칞칚o para mostrar notifica칞칚o
    function showNotification(message, isSuccess = true) {
      notification.textContent = message;
      notification.className = 'notification ' + (isSuccess ? 'success' : 'error') + ' show';
      setTimeout(() => notification.classList.remove('show'), 4000);
    }
    
    // Toggle password visibility
    togglePassword.addEventListener('click', () => {
      const type = clientAccessCodeInput.getAttribute('type') === 'password' ? 'text' : 'password';
      clientAccessCodeInput.setAttribute('type', type);
      togglePassword.classList.toggle('fa-eye');
      togglePassword.classList.toggle('fa-eye-slash');
    });
    
    toggleAdminPassword.addEventListener('click', () => {
      const type = loginPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      loginPasswordInput.setAttribute('type', type);
      toggleAdminPassword.classList.toggle('fa-eye');
      toggleAdminPassword.classList.toggle('fa-eye-slash');
    });
    
    // Fun칞칚o para definir estado de loading
    function setLoading(button, isLoading, defaultText) {
      button.disabled = isLoading;
      button.innerHTML = isLoading 
        ? '<i class="fas fa-spinner fa-spin"></i> Processando...' 
        : defaultText;
    }
    
    // Verificar se estamos no modo de visualiza칞칚o de cliente
    const urlParams = new URLSearchParams(window.location.search);
    const clientIdParam = urlParams.get('clientId');
    
    if (clientIdParam) {
      // Modo de visualiza칞칚o de cliente
      appContainer.style.display = 'none';
      clientView.classList.remove('hidden');
    } else {
      // Modo normal da aplica칞칚o
      clientView.classList.add('hidden');
      appContainer.style.display = 'block';
    }
    
    // Login com email/senha
    loginBtn.addEventListener('click', () => {
      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value.trim();
    
      // Valida칞칚o de email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification('Formato de e-mail inv치lido!', false);
        return;
      }
    
      if (!email || !password) {
        showNotification('Por favor, preencha todos os campos!', false);
        return;
      }
    
      const loginBtnText = loginBtn.innerHTML;
      setLoading(loginBtn, true, loginBtnText);
    
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          showNotification(`Bem-vindo, ${user.email}!`);
          userEmailSpan.textContent = user.email;
          loginSection.classList.add('hidden');
          appSection.classList.remove('hidden');
          loadClients();
          loadProposals();
        })
        .catch((error) => {
          console.error(error);
          let errorMessage = "Erro ao fazer login!";
          if (error.code === 'auth/user-not-found') {
            errorMessage = "Usu치rio n칚o encontrado!";
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = "Senha incorreta!";
          }
          showNotification(errorMessage, false);
        })
        .finally(() => {
          setLoading(loginBtn, false, '<i class="fas fa-sign-in-alt"></i> Entrar');
        });
    });
    
    logoutBtn.addEventListener('click', () => {
      const logoutBtnText = logoutBtn.innerHTML;
      setLoading(logoutBtn, true, logoutBtnText);
      
      auth.signOut().then(() => {
        showNotification('Desconectado com sucesso.');
        loginSection.classList.remove('hidden');
        appSection.classList.add('hidden');
        // Limpar dados locais
        clients = [];
        proposals = [];
        clientsSelect.innerHTML = '<option value="">Selecione um cliente</option>';
        proposalFilter.innerHTML = '<option value="all">Todos os Clientes</option>';
        proposalsList.innerHTML = '';
        markdownOutput.textContent = '';
        currentProposalId = null;
        currentClientForLink = null;
        
        // Limpar campos de login
        loginEmailInput.value = '';
        loginPasswordInput.value = '';
      }).catch(error => {
        showNotification('Erro ao desconectar: ' + error.message, false);
      }).finally(() => {
        setLoading(logoutBtn, false, '<i class="fas fa-sign-out-alt"></i> Sair');
      });
    });
    
    // Verificar estado de autentica칞칚o
    auth.onAuthStateChanged(user => {
      if (user && !clientIdParam) {
        userEmailSpan.textContent = user.email;
        loginSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        loadClients();
        loadProposals();
      } else if (!clientIdParam) {
        loginSection.classList.remove('hidden');
        appSection.classList.add('hidden');
      }
    });
    
    // --- CLIENTES ---
    
    function loadClients() {
      const user = auth.currentUser;
      if (!user) return;
    
      db.collection('clientes').orderBy('name').get()
        .then(snapshot => {
          clients = [];
          clientsSelect.innerHTML = '<option value="">Selecione um cliente</option>';
          proposalFilter.innerHTML = '<option value="all">Todos os Clientes</option>';
    
          if (snapshot.empty) {
            return;
          }
    
          snapshot.forEach(doc => {
            const client = { ...doc.data(), docId: doc.id };
            clients.push(client);
    
            // Adicionar ao seletor de clientes
            const option = document.createElement('option');
            option.value = client.docId;
            option.textContent = client.name;
            clientsSelect.appendChild(option);
    
            // Adicionar ao filtro
            const filterOption = document.createElement('option');
            filterOption.value = client.docId;
            filterOption.textContent = client.name;
            proposalFilter.appendChild(filterOption);
          });
        })
        .catch(error => {
          showNotification('Erro ao carregar clientes: ' + error.message, false);
        });
    }
    
    addClientBtn.addEventListener('click', () => {
      const name = clientNameInput.value.trim();
      if (!name) {
        showNotification('Por favor, insira o nome do cliente!', false);
        return;
      }
    
      const addClientBtnText = addClientBtn.innerHTML;
      setLoading(addClientBtn, true, addClientBtnText);
    
      db.collection('clientes').add({ name })
        .then(() => {
          showNotification('Cliente cadastrado com sucesso!');
          clientNameInput.value = '';
          loadClients();
        })
        .catch(() => {
          showNotification('Erro ao cadastrar cliente!', false);
        })
        .finally(() => {
          setLoading(addClientBtn, false, '<i class="fas fa-user-plus"></i> Cadastrar Cliente');
        });
    });
    
    // --- PROPOSTAS ---
    
    addProposalBtn.addEventListener('click', () => {
      const title = proposalTitleInput.value.trim();
      const link = proposalLinkInput.value.trim();
      const status = proposalStatusSelect.value;
      const clientId = clientsSelect.value;
    
      if (!clientId) return showNotification('Por favor, selecione um cliente!', false);
      if (!title) return showNotification('Por favor, insira um t칤tulo para a proposta!', false);
    
      const client = clients.find(c => c.docId === clientId);
      if (!client) return showNotification('Cliente inv치lido!', false);
    
      const proposalData = {
        title,
        link,
        status,
        clientId,
        clientName: client.name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
    
      const addProposalBtnText = addProposalBtn.innerHTML;
      setLoading(addProposalBtn, true, addProposalBtnText);
    
      // Se estiver editando
      if (currentProposalId) {
        db.collection('propostas').doc(currentProposalId).update(proposalData)
          .then(() => {
            showNotification('Proposta atualizada com sucesso!');
            resetProposalForm();
            loadProposals();
          })
          .catch(() => showNotification('Erro ao atualizar proposta!', false))
          .finally(() => {
            setLoading(addProposalBtn, false, '<i class="fas fa-save"></i> Salvar Proposta');
          });
      } 
      // Se for nova proposta
      else {
        proposalData.id = Date.now();
        db.collection('propostas').add(proposalData)
          .then(() => {
            showNotification('Proposta adicionada com sucesso!');
            resetProposalForm();
            loadProposals();
          })
          .catch(() => showNotification('Erro ao adicionar proposta!', false))
          .finally(() => {
            setLoading(addProposalBtn, false, '<i class="fas fa-save"></i> Salvar Proposta');
          });
      }
    });
    
    // Fun칞칚o resetProposalForm atualizada para limpar TODOS os campos
    function resetProposalForm() {
      proposalTitleInput.value = '';
      proposalLinkInput.value = '';
      proposalStatusSelect.value = 'elaboracao';
      clientsSelect.value = '';
      currentProposalId = null;
    }
    
    function loadProposals() {
      const user = auth.currentUser;
      if (!user) return;
    
      db.collection('propostas').orderBy('createdAt', 'desc').get().then((querySnapshot) => {
        proposals = [];
        proposalsList.innerHTML = '';
    
        if (querySnapshot.empty) {
          proposalsList.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px;">
          <i class="fas fa-inbox" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
          <p>Nenhuma proposta cadastrada ainda.</p></td></tr>`;
          markdownOutput.textContent = '## Nenhuma proposta cadastrada';
          return;
        }
    
        querySnapshot.forEach((doc) => {
          proposals.push({ ...doc.data(), docId: doc.id });
        });
    
        renderProposals();
        generateMarkdown();
      }).catch(error => {
        showNotification('Erro ao carregar propostas: ' + error.message, false);
      });
    }
    
    function renderProposals() {
      proposalsList.innerHTML = '';
    
      if(proposals.length === 0){
        proposalsList.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px;">Nenhuma proposta cadastrada.</td></tr>`;
        return;
      }
    
      // Filtrar propostas pelo cliente selecionado
      let filteredProposals = proposals;
      if (currentFilter !== "all") {
        filteredProposals = proposals.filter(p => p.clientId === currentFilter);
      }
    
      filteredProposals.forEach(proposal => {
        let statusClass = '', statusText = '';
        switch(proposal.status) {
          case 'elaboracao': statusClass = 'status-elaboracao'; statusText = '游리 Em Elabora칞칚o'; break;
          case 'aprovacao': statusClass = 'status-aprovacao'; statusText = '游 Em Aprova칞칚o do Cliente'; break;
          case 'aprovado': statusClass = 'status-aprovado'; statusText = '游릭 Aprovado'; break;
          case 'cancelado': statusClass = 'status-cancelado'; statusText = '游댮 Cancelado'; break;
        }
    
        const row = document.createElement('tr');
        row.innerHTML = `<td>${proposal.title}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${proposal.clientName || 'Sem cliente'}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editProposalByDocId('${proposal.docId}')"><i class="fas fa-edit"></i></button>
            <button class="action-btn delete-btn" onclick="deleteProposalByDocId('${proposal.docId}')"><i class="fas fa-trash-alt"></i></button>
          </td>`;
    
        proposalsList.appendChild(row);
      });
    }
    
    function generateMarkdown() {
      if (proposals.length === 0) {
        markdownOutput.textContent = '## Nenhuma proposta cadastrada';
        return;
      }
    
      // Filtrar propostas pelo cliente selecionado
      let filteredProposals = proposals;
      if (currentFilter !== "all") {
        filteredProposals = proposals.filter(p => p.clientId === currentFilter);
      }
    
      let markdown = '';
      
      if (currentFilter === "all") {
        markdown += '## Lista de Propostas para Todos os Clientes\n\n';
      } else {
        const client = clients.find(c => c.docId === currentFilter);
        markdown += `## Lista de Propostas para: ${client ? client.name : 'Cliente Selecionado'}\n\n`;
      }
    
      markdown += '| T칤tulo | Status | Cliente | Link |\n';
      markdown += '|--------|--------|---------|------|\n';
    
      filteredProposals.forEach(p => {
        const statusMap = {
          'elaboracao': 'Em elabora칞칚o',
          'aprovacao': 'Em aprova칞칚o do cliente',
          'aprovado': 'Aprovado',
          'cancelado': 'Cancelado'
        };
        markdown += `| ${p.title} | ${statusMap[p.status]} | ${p.clientName || '-'} | [Link](${p.link || '#'}) |\n`;
      });
    
      markdownOutput.textContent = markdown;
    }
    
    // Aplicar filtro automaticamente ao mudar o cliente
    proposalFilter.addEventListener('change', () => {
      currentFilter = proposalFilter.value;
      renderProposals();
      generateMarkdown();
    });
    
    // Download markdown
    document.getElementById('download-md').addEventListener('click', () => {
      const markdown = markdownOutput.textContent;
      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      if (currentFilter === "all") {
        a.download = 'propostas-todos.md';
      } else {
        const client = clients.find(c => c.docId === currentFilter);
        a.download = `propostas-${client ? client.name.replace(/\s+/g, '-') : 'cliente'}.md`;
      }
      
      a.click();
      URL.revokeObjectURL(url);
      showNotification('Markdown baixado com sucesso!');
    });
    
    // Fun칞칫es globais para os bot칫es de a칞칚o
    window.editProposalByDocId = function(docId) {
      const proposal = proposals.find(p => p.docId === docId);
      if (!proposal) return;
    
      proposalTitleInput.value = proposal.title;
      proposalLinkInput.value = proposal.link || '';
      proposalStatusSelect.value = proposal.status;
      clientsSelect.value = proposal.clientId || '';
      currentProposalId = docId;
    
      showNotification('Proposta carregada para edi칞칚o!');
    }
    
    window.deleteProposalByDocId = function(docId) {
      if (!confirm('Tem certeza que deseja excluir esta proposta?')) return;
    
      db.collection('propostas').doc(docId).delete()
        .then(() => {
          showNotification('Proposta exclu칤da com sucesso!');
          loadProposals();
        });
    }
    
    // --- GERAR LINKS DE TABELA COM AUTENTICA칂츾O ---
    
    // Gerar link para tabela do cliente com autentica칞칚o
    generateLinkBtn.addEventListener('click', () => {
      if (currentFilter === 'all') {
        showNotification('Selecione um cliente espec칤fico para gerar o link.', false);
        return;
      }
      
      currentClientForLink = clients.find(c => c.docId === currentFilter);
      if (!currentClientForLink) return;
      
      // Gerar c칩digo de acesso 칰nico
      clientAccessCode = generateAccessCode();
      
      // Gerar URL 칰nica para o cliente
      const baseUrl = window.location.href.split('?')[0];
      const url = `${baseUrl}?clientId=${currentClientForLink.docId}`;
      
      iframeLink.value = url;
      accessCodeInput.value = clientAccessCode;
      
      // Gerar c칩digo iframe
      const iframeHtml = `<iframe src="${url}" width="100%" height="500" frameborder="0" style="border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);"></iframe>`;
      iframeCode.value = iframeHtml;
      
      // Exibir modal
      linkModal.style.display = 'block';
    });
    
    // Copiar c칩digo iframe
    copyCodeBtn.addEventListener('click', () => {
      iframeCode.select();
      document.execCommand('copy');
      showNotification('C칩digo copiado para a 치rea de transfer칡ncia!');
    });
    
    // Fechar modal
    closeModal.addEventListener('click', () => {
      linkModal.style.display = 'none';
    });
    
    window.addEventListener('click', (e) => {
      if (e.target === linkModal) {
        linkModal.style.display = 'none';
      }
    });
    
    // Autentica칞칚o do cliente para visualiza칞칚o
    clientLoginBtn.addEventListener('click', () => {
      const enteredCode = clientAccessCodeInput.value.trim().toUpperCase();
      
      if (!enteredCode) {
        showNotification('Por favor, insira o c칩digo de acesso!', false);
        return;
      }
      
      // Verificar se o c칩digo inserido corresponde ao gerado
      if (enteredCode === clientAccessCode) {
        // Autentica칞칚o bem-sucedida
        clientAuthSection.classList.add('hidden');
        clientProposalsSection.classList.remove('hidden');
        loadClientProposals(clientIdParam);
      } else {
        showNotification('C칩digo de acesso inv치lido!', false);
      }
    });
    
    // Logout do cliente
    clientLogoutBtn.addEventListener('click', () => {
      clientAuthSection.classList.remove('hidden');
      clientProposalsSection.classList.add('hidden');
      clientAccessCodeInput.value = '';
    });
    
    // Carregar propostas do cliente para visualiza칞칚o
    function loadClientProposals(clientId) {
      // Mostrar loader enquanto carrega
      clientProposalsList.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:30px;"><div class="loader"></div></td></tr>`;
      
      setTimeout(() => {
        db.collection('propostas').where('clientId', '==', clientId)
          .orderBy('createdAt', 'desc')
          .get()
          .then(snapshot => {
            clientProposalsList.innerHTML = '';
            
            if (snapshot.empty) {
              clientProposalsList.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:30px;">Nenhuma proposta encontrada para este cliente.</td></tr>`;
              return;
            }
            
            snapshot.forEach(doc => {
              const proposal = doc.data();
              let statusClass = '', statusText = '';
              
              switch(proposal.status) {
                case 'elaboracao': statusClass = 'status-elaboracao'; statusText = '游리 Em Elabora칞칚o'; break;
                case 'aprovacao': statusClass = 'status-aprovacao'; statusText = '游 Em Aprova칞칚o do Cliente'; break;
                case 'aprovado': statusClass = 'status-aprovado'; statusText = '游릭 Aprovado'; break;
                case 'cancelado': statusClass = 'status-cancelado'; statusText = '游댮 Cancelado'; break;
              }
              
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${proposal.title}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td><a href="${proposal.link || '#'}" target="_blank" style="color: #1a2a6c; text-decoration: none; font-weight: bold;">
                  <i class="fas fa-external-link-alt"></i> Acessar
                </a></td>
              `;
              clientProposalsList.appendChild(row);
            });
          })
          .catch(error => {
            console.error('Erro ao carregar propostas do cliente:', error);
            clientProposalsList.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:30px; color: #f44336;">
              Erro ao carregar propostas. Tente novamente mais tarde.
            </td></tr>`;
          });
      }, 1000); // Simular tempo de carregamento
    }
    
    // Efeito de ripple nos bot칫es
    document.querySelectorAll('.ripple').forEach(button => {
      button.addEventListener('click', function(e) {
        const ripple = document.createElement('span');
        ripple.classList.add('ripple-effect');
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size/2;
        const y = e.clientY - rect.top - size/2;
        
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        ripple.style.animation = 'ripple 0.6s linear';
        
        this.appendChild(ripple);
        
        setTimeout(() => {
          ripple.remove();
        }, 600);
      });
    });
    
    // Estilo para o efeito ripple
    const style = document.createElement('style');
    style.innerHTML = `
      .ripple-effect {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        transform: scale(0);
        animation: ripple 0.6s linear;
      }
      
      @keyframes ripple {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
