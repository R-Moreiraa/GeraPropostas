<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Propostas com Firebase</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: white;
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: White;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #000);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: white;
        }
        
        h2 {
            color: #1a2a6c;
            border-bottom: 2px solid #b21f1f;
            padding-bottom: 10px;
            margin: 25px 0 15px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .form-group {
            margin-bottom: 20px;
            color: #000;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #1a2a6c;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            border-color: #1a2a6c;
            outline: none;
            box-shadow: 0 0 5px rgba(26, 42, 108, 0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #1a2a6c, #8a1a1a);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .proposal-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .proposal-list th {
            background: #1a2a6c;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .proposal-list td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .proposal-list tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .proposal-list tr:hover {
            background-color: #f0f5ff;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
            display: inline-block;
        }
        
        .status-elaboracao {
            background-color: #ffeb3b;
            color: #000;
        }
        
        .status-aprovacao {
            background-color: #f1a10e;
            color: #000;
        }
        
        .status-aprovado {
            background-color: #4caf50;
            color: #000;
        }
        
        .status-cancelado {
            background-color: #f44336;
            color: #000;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .edit-btn {
            color: #1a2a6c;
        }
        
        .delete-btn {
            color: #b21f1f;
        }
        
        .action-btn:hover {
            transform: scale(1.2);
        }
        
        .markdown-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            background: #1a2a6c;
            color: white;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .download-btn {
            margin-top: 20px;
            background: linear-gradient(to right, #4caf50, #2e7d32);
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #1a2a6c;
            margin-top: 30px;
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(to right, #4caf50, #2e7d32);
        }
        
        .notification.error {
            background: linear-gradient(to right, #f44336, #b71c1c);
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f5ff;
            border-radius: 8px;
        }
        
        .user-phone {
            font-weight: bold;
            color: #1a2a6c;
        }
        
        .logout-btn {
            background: linear-gradient(to right, #b21f1f, #8a1a1a);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .proposal-list {
                font-size: 0.9rem;
            }
            
            .proposal-list th, .proposal-list td {
                padding: 10px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .filter-container label {
            margin-bottom: 0;
            white-space: nowrap;
            font-weight: bold;
            color: #1a2a6c;
        }
        
        .filter-container select {
            flex: 1;
        }
        
        .filter-btn {
            background: #1a2a6c;
        }
        
        .client-card {
            background: #f0f5ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-name {
            font-weight: bold;
            color: #1a2a6c;
        }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gerador de Propostas</h1>
      <p style="text-align: center;">Gerencie suas propostas e gere relatÃ³rios em Markdown</p>
    </header>

    <!-- Tela de login -->
    <div id="login-section">
      <h2><i class="fas fa-sign-in-alt"></i> Login / Cadastro por Telefone</h2>

      <div class="card">
        <div class="form-group">
          <label for="phone-number">NÃºmero de telefone</label>
          <input type="text" id="phone-number" placeholder="+55 11 99999-9999" />
        </div>

        <div id="recaptcha-container"></div>

        <button id="send-code-btn" class="btn"><i class="fas fa-paper-plane"></i> Enviar CÃ³digo</button>

        <div id="verification-code-section" class="hidden">
          <div class="form-group">
            <label for="verification-code">CÃ³digo de VerificaÃ§Ã£o</label>
            <input type="text" id="verification-code" placeholder="Digite o cÃ³digo recebido" />
          </div>
          <button id="verify-code-btn" class="btn"><i class="fas fa-check"></i> Verificar CÃ³digo</button>
        </div>
      </div>
    </div>

    <!-- ConteÃºdo do app que sÃ³ aparece quando usuÃ¡rio estÃ¡ logado -->
    <div id="app-section" class="hidden">
      <div class="user-info">
        <div>
          <span class="user-phone" id="user-phone"></span>
        </div>
        <button id="logout-btn" class="btn logout-btn">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
      </div>

      <!-- Ãrea de Clientes -->
      <div class="card">
        <h2><i class="fas fa-users"></i> Clientes</h2>
        <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="client-name" placeholder="Nome do cliente" style="flex:1;" />
          <button id="add-client-btn" class="btn" style="flex-shrink: 0;">
            <i class="fas fa-user-plus"></i> Cadastrar Cliente
          </button>
        </div>
        
        <div id="clients-list">
          <!-- Clientes serÃ£o carregados aqui -->
        </div>
      </div>

      <!-- Ãrea de Propostas -->
      <div class="card">
        <h2><i class="fas fa-plus-circle"></i> Adicionar Nova Proposta</h2>
        <div class="form-group">
          <label for="proposal-title">TÃ­tulo da Proposta</label>
          <input type="text" id="proposal-title" placeholder="Digite o tÃ­tulo da proposta" />
        </div>
        <div class="form-group">
          <label for="proposal-link">Link da Proposta</label>
          <input type="text" id="proposal-link" placeholder="https://exemplo.com/proposta" />
        </div>
        <div class="form-group">
          <label for="proposal-status">Status da Proposta</label>
          <select id="proposal-status">
            <option value="elaboracao">ðŸŸ¡ Em elaboraÃ§Ã£o</option>
            <option value="aprovacao">ðŸŸ  Em aprovaÃ§Ã£o do cliente</option>
            <option value="aprovado">ðŸŸ¢ Aprovado</option>
            <option value="cancelado">ðŸ”´ Cancelado</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="clients-select">Selecione o Cliente</label>
          <select id="clients-select" style="width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 1rem; margin-bottom: 20px;">
            <option value="">Selecione um cliente</option>
          </select>
        </div>
        
        <button id="add-proposal" class="btn">
          <i class="fas fa-save"></i> Salvar Proposta
        </button>
      </div>

      <div class="card">
        <h2><i class="fas fa-list"></i> Lista de Propostas</h2>
        
        <!-- Filtro por cliente -->
        <div class="filter-container">
          <label for="proposal-filter">Filtrar por Cliente:</label>
          <select id="proposal-filter">
            <option value="all">Todos os Clientes</option>
          </select>
          <button id="apply-filter" class="btn filter-btn">
            <i class="fas fa-filter"></i> Aplicar
          </button>
        </div>
        
        <table class="proposal-list">
          <thead>
            <tr>
              <th>TÃ­tulo</th>
              <th>Status</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="proposals-list"></tbody>
        </table>
      </div>

      <div class="card">
        <h2><i class="fab fa-markdown"></i> Tabela Markdown Gerada</h2>
        <p>Esta tabela serÃ¡ atualizada automaticamente conforme as propostas sÃ£o adicionadas ou editadas.</p>
        <div class="markdown-container" id="markdown-output"></div>
        <button id="download-md" class="btn download-btn">
          <i class="fas fa-download"></i> Baixar Markdown
        </button>
      </div>
    </div>

    <div id="notification" class="notification"></div>
    
    <footer>
      <p>Gerador de Propostas &copy; 2023 - Todos os direitos reservados</p>
    </footer>
  </div>

  <script>
    // ConfiguraÃ§Ã£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhue_2qisBA2Ihe6WPKfonf0NSE4WZnPg",
      authDomain: "gera-propostas.firebaseapp.com",
      projectId: "gera-propostas",
      storageBucket: "gera-propostas.appspot.com",
      messagingSenderId: "517918747792",
      appId: "1:517918747792:web:568b86b22e0e5709823c15",
      measurementId: "G-CJCK09C7D8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ConfiguraÃ§Ã£o de persistÃªncia de sessÃ£o
    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
      .catch((error) => {
        console.error("Erro ao configurar persistÃªncia:", error);
      });

    // Elementos do DOM
    const loginSection = document.getElementById('login-section');
    const appSection = document.getElementById('app-section');
    const userPhoneSpan = document.getElementById('user-phone');

    const phoneNumberInput = document.getElementById('phone-number');
    const sendCodeBtn = document.getElementById('send-code-btn');
    const verificationCodeSection = document.getElementById('verification-code-section');
    const verificationCodeInput = document.getElementById('verification-code');
    const verifyCodeBtn = document.getElementById('verify-code-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const notification = document.getElementById('notification');

    // Elementos Clientes
    const clientNameInput = document.getElementById('client-name');
    const addClientBtn = document.getElementById('add-client-btn');
    const clientsSelect = document.getElementById('clients-select');
    const clientsList = document.getElementById('clients-list');

    // Elementos Propostas
    const proposalTitleInput = document.getElementById('proposal-title');
    const proposalLinkInput = document.getElementById('proposal-link');
    const proposalStatusSelect = document.getElementById('proposal-status');
    const addProposalBtn = document.getElementById('add-proposal');
    const proposalsList = document.getElementById('proposals-list');
    const markdownOutput = document.getElementById('markdown-output');

    // Elementos de Filtro
    const proposalFilter = document.getElementById('proposal-filter');
    const applyFilterBtn = document.getElementById('apply-filter');

    // VariÃ¡veis
    let confirmationResult;
    let clients = [];
    let proposals = [];
    let currentFilter = "all";

    function showNotification(message, isSuccess = true) {
      notification.textContent = message;
      notification.className = 'notification ' + (isSuccess ? 'success' : 'error') + ' show';
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // Inicializa o recaptcha invisÃ­vel
    let recaptchaVerifier;
    window.onload = () => {
      recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        size: 'invisible',
      });
      recaptchaVerifier.render();

      sendCodeBtn.addEventListener('click', () => {
        const phoneNumber = phoneNumberInput.value.trim();
        if (!phoneNumber) {
          showNotification('Por favor, insira um nÃºmero de telefone vÃ¡lido!', false);
          return;
        }
        sendCodeBtn.disabled = true;
        auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifier)
          .then((result) => {
            confirmationResult = result;
            showNotification('CÃ³digo enviado! Verifique seu celular.');
            verificationCodeSection.classList.remove('hidden');
          })
          .catch((error) => {
            console.error(error);
            showNotification('Erro ao enviar cÃ³digo: ' + error.message, false);
          })
          .finally(() => {
            sendCodeBtn.disabled = false;
          });
      });

      verifyCodeBtn.addEventListener('click', () => {
        const code = verificationCodeInput.value.trim();
        if (!code) {
          showNotification('Por favor, insira o cÃ³digo de verificaÃ§Ã£o!', false);
          return;
        }
        verifyCodeBtn.disabled = true;
        confirmationResult.confirm(code)
          .then((result) => {
            const user = result.user;
            showNotification(`Bem-vindo, usuÃ¡rio ${user.phoneNumber}!`);
            userPhoneSpan.textContent = user.phoneNumber;
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            loadClients();
            loadProposals();
          })
          .catch((error) => {
            console.error(error);
            showNotification('CÃ³digo invÃ¡lido ou expirado.', false);
          })
          .finally(() => {
            verifyCodeBtn.disabled = false;
          });
      });

      logoutBtn.addEventListener('click', () => {
        logoutBtn.disabled = true;
        auth.signOut().then(() => {
          showNotification('Desconectado com sucesso.');
          loginSection.classList.remove('hidden');
          appSection.classList.add('hidden');
          // Limpar dados locais
          clients = [];
          proposals = [];
          clientsSelect.innerHTML = '<option value="">Selecione um cliente</option>';
          proposalFilter.innerHTML = '<option value="all">Todos os Clientes</option>';
          clientsList.innerHTML = '';
          proposalsList.innerHTML = '';
          markdownOutput.textContent = '';
        }).catch(error => {
          showNotification('Erro ao desconectar: ' + error.message, false);
        }).finally(() => {
          logoutBtn.disabled = false;
        });
      });

      // Verificar estado de autenticaÃ§Ã£o
      auth.onAuthStateChanged(user => {
        if (user) {
          userPhoneSpan.textContent = user.phoneNumber;
          loginSection.classList.add('hidden');
          appSection.classList.remove('hidden');
          loadClients();
          loadProposals();
        } else {
          loginSection.classList.remove('hidden');
          appSection.classList.add('hidden');
        }
      });
    };

    // --- CLIENTES ---

    function loadClients() {
      const user = auth.currentUser;
      if (!user) return;

      db.collection('clientes').orderBy('name').get()
        .then(snapshot => {
          clients = [];
          clientsSelect.innerHTML = '<option value="">Selecione um cliente</option>';
          proposalFilter.innerHTML = '<option value="all">Todos os Clientes</option>';
          clientsList.innerHTML = '';

          if (snapshot.empty) {
            clientsList.innerHTML = '<p>Nenhum cliente cadastrado ainda.</p>';
            return;
          }

          snapshot.forEach(doc => {
            const client = { ...doc.data(), docId: doc.id };
            clients.push(client);

            // Adicionar ao seletor de clientes
            const option = document.createElement('option');
            option.value = client.docId;
            option.textContent = client.name;
            clientsSelect.appendChild(option);

            // Adicionar ao filtro
            const filterOption = document.createElement('option');
            filterOption.value = client.docId;
            filterOption.textContent = client.name;
            proposalFilter.appendChild(filterOption);

            // Adicionar Ã  lista de clientes
            const clientCard = document.createElement('div');
            clientCard.className = 'client-card';
            clientCard.innerHTML = `
              <span class="client-name">${client.name}</span>
              <button class="action-btn delete-btn" onclick="deleteClient('${client.docId}')">
                <i class="fas fa-trash-alt"></i>
              </button>
            `;
            clientsList.appendChild(clientCard);
          });
        })
        .catch(error => {
          showNotification('Erro ao carregar clientes: ' + error.message, false);
        });
    }

    addClientBtn.addEventListener('click', () => {
      const name = clientNameInput.value.trim();
      if (!name) {
        showNotification('Por favor, insira o nome do cliente!', false);
        return;
      }

      db.collection('clientes').add({ name })
        .then(() => {
          showNotification('Cliente cadastrado com sucesso!');
          clientNameInput.value = '';
          loadClients();
        })
        .catch(() => {
          showNotification('Erro ao cadastrar cliente!', false);
        });
    });

    window.deleteClient = function(docId) {
      if (!confirm('Tem certeza que deseja excluir este cliente? Todas as propostas associadas tambÃ©m serÃ£o excluÃ­das.')) return;
      
      db.collection('clientes').doc(docId).delete()
        .then(() => {
          showNotification('Cliente excluÃ­do com sucesso!');
          // Excluir todas as propostas associadas a este cliente
          const batch = db.batch();
          proposals.filter(p => p.clientId === docId).forEach(p => {
            const propRef = db.collection('propostas').doc(p.docId);
            batch.delete(propRef);
          });
          
          return batch.commit();
        })
        .then(() => {
          loadClients();
          loadProposals();
        })
        .catch(error => {
          showNotification('Erro ao excluir cliente: ' + error.message, false);
        });
    }

    // --- PROPOSTAS ---

    addProposalBtn.addEventListener('click', () => {
      const title = proposalTitleInput.value.trim();
      const link = proposalLinkInput.value.trim();
      const status = proposalStatusSelect.value;
      const clientId = clientsSelect.value;

      if (!clientId) return showNotification('Por favor, selecione um cliente!', false);
      if (!title) return showNotification('Por favor, insira um tÃ­tulo para a proposta!', false);

      const client = clients.find(c => c.docId === clientId);
      if (!client) return showNotification('Cliente invÃ¡lido!', false);

      const newProposal = {
        id: Date.now(),
        title,
        link,
        status,
        clientId,
        clientName: client.name
      };

      db.collection('propostas').add(newProposal).then(() => {
        showNotification('Proposta adicionada com sucesso!');
        proposalTitleInput.value = '';
        proposalLinkInput.value = '';
        proposalStatusSelect.value = 'elaboracao';
        loadProposals();
      }).catch(() => showNotification('Erro ao adicionar proposta!', false));
    });

    function loadProposals() {
      const user = auth.currentUser;
      if (!user) return;

      db.collection('propostas').orderBy('id', 'desc').get().then((querySnapshot) => {
        proposals = [];
        proposalsList.innerHTML = '';

        if (querySnapshot.empty) {
          proposalsList.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 30px;">
          <i class="fas fa-inbox" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
          <p>Nenhuma proposta cadastrada ainda.</p></td></tr>`;
          markdownOutput.textContent = '## Nenhuma proposta cadastrada';
          return;
        }

        querySnapshot.forEach((doc) => {
          proposals.push({ ...doc.data(), docId: doc.id });
        });

        renderProposals();
        generateMarkdown();
      }).catch(error => {
        showNotification('Erro ao carregar propostas: ' + error.message, false);
      });
    }

    function renderProposals() {
      proposalsList.innerHTML = '';

      if(proposals.length === 0){
        proposalsList.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:30px;">Nenhuma proposta cadastrada.</td></tr>`;
        return;
      }

      // Filtrar propostas pelo cliente selecionado
      let filteredProposals = proposals;
      if (currentFilter !== "all") {
        filteredProposals = proposals.filter(p => p.clientId === currentFilter);
      }

      // Agrupar propostas por cliente
      const groupedByClient = filteredProposals.reduce((acc, proposal) => {
        if (!acc[proposal.clientId]) {
          acc[proposal.clientId] = {
            clientName: proposal.clientName,
            proposals: []
          };
        }
        acc[proposal.clientId].proposals.push(proposal);
        return acc;
      }, {});

      // Exibir agrupado
      for (const clientId in groupedByClient) {
        const group = groupedByClient[clientId];

        const clientRow = document.createElement('tr');
        clientRow.innerHTML = `<td colspan="3" style="background: #1a2a6c; color: white; font-weight: bold; padding: 10px;">
          <i class="fas fa-user"></i> Cliente: ${group.clientName}</td>`;
        proposalsList.appendChild(clientRow);

        group.proposals.forEach(proposal => {
          let statusClass = '', statusText = '';
          switch(proposal.status) {
            case 'elaboracao': statusClass = 'status-elaboracao'; statusText = 'ðŸŸ¡ Em ElaboraÃ§Ã£o'; break;
            case 'aprovacao': statusClass = 'status-aprovacao'; statusText = 'ðŸŸ  Em AprovaÃ§Ã£o do Cliente'; break;
            case 'aprovado': statusClass = 'status-aprovado'; statusText = 'ðŸŸ¢ Aprovado'; break;
            case 'cancelado': statusClass = 'status-cancelado'; statusText = 'ðŸ”´ Cancelado'; break;
          }

          const row = document.createElement('tr');
          row.innerHTML = `<td>${proposal.title}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
              <button class="action-btn edit-btn" onclick="editProposalByDocId('${proposal.docId}')"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete-btn" onclick="deleteProposalByDocId('${proposal.docId}')"><i class="fas fa-trash-alt"></i></button>
            </td>`;

          proposalsList.appendChild(row);
        });
      }
    }

    function generateMarkdown() {
      if (proposals.length === 0) {
        markdownOutput.textContent = '## Nenhuma proposta cadastrada';
        return;
      }

      // Filtrar propostas pelo cliente selecionado
      let filteredProposals = proposals;
      if (currentFilter !== "all") {
        filteredProposals = proposals.filter(p => p.clientId === currentFilter);
      }

      const groupedByClient = filteredProposals.reduce((acc, p) => {
        if (!acc[p.clientId]) {
          acc[p.clientId] = {
            clientName: p.clientName,
            proposals: []
          };
        }
        acc[p.clientId].proposals.push(p);
        return acc;
      }, {});

      let markdown = '';
      
      if (currentFilter === "all") {
        markdown += '## Lista de Propostas para Todos os Clientes\n\n';
      } else {
        const client = clients.find(c => c.docId === currentFilter);
        markdown += `## Lista de Propostas para: ${client ? client.name : 'Cliente Selecionado'}\n\n`;
      }

      for (const clientId in groupedByClient) {
        const group = groupedByClient[clientId];
        
        if (currentFilter === "all") {
          markdown += `### Cliente: ${group.clientName}\n\n`;
        }
        
        markdown += '| TÃ­tulo | Status | Link |\n|--------|--------|------|\n';

        group.proposals.forEach(p => {
          const statusMap = {
            'elaboracao': 'Em elaboraÃ§Ã£o',
            'aprovacao': 'Em aprovaÃ§Ã£o do cliente',
            'aprovado': 'Aprovado',
            'cancelado': 'Cancelado'
          };
          markdown += `| ${p.title} | ${statusMap[p.status]} | [Link](${p.link || '#'}) |\n`;
        });

        markdown += '\n';
      }

      markdownOutput.textContent = markdown;
    }

    // Aplicar filtro
    applyFilterBtn.addEventListener('click', () => {
      currentFilter = proposalFilter.value;
      renderProposals();
      generateMarkdown();
    });

    // Download markdown
    document.getElementById('download-md').addEventListener('click', () => {
      const markdown = markdownOutput.textContent;
      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      if (currentFilter === "all") {
        a.download = 'propostas-todos.md';
      } else {
        const client = clients.find(c => c.docId === currentFilter);
        a.download = `propostas-${client ? client.name.replace(/\s+/g, '-') : 'cliente'}.md`;
      }
      
      a.click();
      URL.revokeObjectURL(url);
      showNotification('Markdown baixado com sucesso!');
    });

    // FunÃ§Ãµes globais para os botÃµes de aÃ§Ã£o
    window.editProposalByDocId = function(docId) {
      const proposal = proposals.find(p => p.docId === docId);
      if (!proposal) return;

      proposalTitleInput.value = proposal.title;
      proposalLinkInput.value = proposal.link;
      proposalStatusSelect.value = proposal.status;
      clientsSelect.value = proposal.clientId || '';

      // Apagar proposta para substituir na ediÃ§Ã£o
      db.collection('propostas').doc(docId).delete()
        .then(() => {
          showNotification('Proposta carregada para ediÃ§Ã£o!');
          loadProposals();
        });
    }

    window.deleteProposalByDocId = function(docId) {
      if (!confirm('Tem certeza que deseja excluir esta proposta?')) return;

      db.collection('propostas').doc(docId).delete()
        .then(() => {
          showNotification('Proposta excluÃ­da com sucesso!');
          loadProposals();
        });
    }
  </script>
</body>
</html>
